<style>
    body { font-family: Arial; margin: 10px; transition: background 0.3s; }
    #character-container { width: 300px; height: 400px; margin: 0 auto; position: relative; }
    #live2d-canvas { width: 100%; height: 100%; }
    #chat-window { height: 200px; overflow-y: scroll; border: 1px solid; padding: 10px; margin-top: 10px; }
    #input-area { display: flex; margin-top: 10px; }
    #user-input { flex: 1; padding: 10px; border: 1px solid; }
    #send-btn { padding: 10px 20px; background: #ff69b4; color: white; border: none; cursor: pointer; }
    /* Default light theme fallback */
    body { background: #f0f0f0; color: #000; }
    #chat-window, #user-input { background: #fff; border-color: #ccc; color: #000; }
</style>
<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand(); // Full screen

    // Apply Telegram theme to fix dark mode blankness
    const theme = tg.themeParams;
    document.body.style.background = theme.bg_color || '#f0f0f0';
    document.body.style.color = theme.text_color || '#000';
    document.getElementById('chat-window').style.background = theme.secondary_bg_color || '#fff';
    document.getElementById('chat-window').style.borderColor = theme.hint_color || '#ccc';
    document.getElementById('chat-window').style.color = theme.text_color || '#000';
    document.getElementById('user-input').style.background = theme.secondary_bg_color || '#fff';
    document.getElementById('user-input').style.borderColor = theme.hint_color || '#ccc';
    document.getElementById('user-input').style.color = theme.text_color || '#000';
    document.getElementById('send-btn').style.background = theme.button_color || '#ff69b4';
    document.getElementById('send-btn').style.color = theme.button_text_color || '#fff';

    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    sendBtn.addEventListener('click', async () => {
        const message = userInput.value.trim();
        if (!message) return;
        chatWindow.innerHTML += `<p style="color: ${theme.text_color || '#000'}"><strong>You:</strong> ${message}</p>`;
        userInput.value = '';
        try {
            const res = await fetch('https://your-render-backend-url.com/chat', { // Replace with your Render URL from next step
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message, initData: tg.initData })
            }).then(r => r.json());
            chatWindow.innerHTML += `<p style="color: ${theme.text_color || '#000'}"><strong>Ani:</strong> ${res.text}</p>`;
            chatWindow.scrollTop = chatWindow.scrollHeight;

            // TTS for talking
            const utterance = new SpeechSynthesisUtterance(res.text);
            utterance.voice = speechSynthesis.getVoices().find(v => v.lang.startsWith('ja-')) || null; // Japanese for anime
            speechSynthesis.speak(utterance);

            // Emotion trigger (for character, added in Step 5)
            if (res.emotion === 'flirty') {
                // Future Live2D motion
            }
        } catch (e) {
            chatWindow.innerHTML += `<p style="color: red">Error: ${e.message}</p>`;
        }
    });

    speechSynthesis.onvoiceschanged = () => {}; // Load voices
</script>